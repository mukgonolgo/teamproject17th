<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">

<head>
   <!-- moment.js 포함 (필수) -->
   <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
   <!-- daterangepicker CSS 포함 -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
   <!-- daterangepicker JS 포함 -->
   <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
   <!-- 커스텀 CSS 추가 -->
   <link rel="stylesheet" href="/css/review_page.css">
   <link rel="stylesheet" href="/css/category.css">
   <!-- 자바스크립트 파일 포함 (라이브러리 이후에 로드) -->
   <script src="js/review_page_category.js"></script>
   <meta name="_csrf" th:content="${_csrf.token}" />
   <meta name="_csrf_header" th:content="${_csrf.headerName}" />

   <!-- 지도 API 포함 -->
   <script type="text/javascript"
      src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4711bf21a08674cf6e20b64443d34887"></script>

   <style>
      #map {
         display: none;
         /* 초기에는 지도가 보이지 않도록 설정 */
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         z-index: 1000;
      }
     
     #test{
      width: 200px;
      height: 200px;
      position: absolute;
      z-index: 999999999;
     }

      #closeMap {
         display: none;
         /* 초기에는 버튼이 보이지 않도록 설정 */
         position: fixed;
         top: 10px;
         right: 10px;
         z-index: 1001;
         background-color: #fff;
         border: none;
         padding: 10px 20px;
         font-size: 16px;
         cursor: pointer;
      }
	  .card-body {
	      padding: 5px; /* 패딩을 줄여서 박스 크기를 줄임 */
	      height: auto; /* 높이를 자동으로 조정 */
	  }

	  .card {
	      height: auto; /* 카드 전체 높이를 자동으로 조정 */
	      display: flex;
	      flex-direction: column;
	      justify-content: space-between; /* 내용들이 균등하게 분포되도록 조정 */
	  }

	  .card-title {
	      font-size: 20px; /* 텍스트 크기를 적절하게 조정 */
		  margin-top: 20px;
	      margin-bottom: 35px; /* 이름 아래에 추가적인 여백을 최소화 */
	  }

   </style>
</head>
<div layout:fragment="content">
   <!-- 검색란 -->
   <div class="section1 container mt-5">
      <div class="row d-flex justify-content-end">
         <!--지역선택-->
         <div class="col-auto">
            <select name="h_area1" id="region1" onChange="updateSubRegion()" class="h_area1 form-control">
               <option>-지역선택-</option>
               <option value="seoul">서울</option>
               <option value="busan">부산</option>
               <option value="gyeonggi">경기도</option>
               <option value="daegu">대구</option>
               <!-- 기타 지역들 추가 -->
            </select>
         </div>

         <!--동네 선택-->
         <div class="col-auto">
            <select name="h_area2" id="region2" class="form-control">
               <option>-선택-</option>
            </select>
         </div>

         <!--인원수 선택-->
         <div class="col-auto">
            <!--People Count Button-->
            <button class="btn text-secondary bg-white P_C_button category_btn" id="toggleButton">
               인원수<i class="fa-solid fa-user ml-1"></i>
            </button>
            <!--인원수 박스-->
            <div class="card ml-5 mt-5 hide_box" id="rangeBox" style="width: 300px;">
               <div class="card-body text-center">
                  <span>인원</span> <label id="rangeValue" for="customRange2">1</label><span>명</span>
                  <input type="range" class="custom-range" min="1" max="10" value="1" id="customRange2">
               </div>
               <button class="btn btn-dark ca_button w-100">인원수 적용</button>
            </div>
         </div>

         <!-- 날짜 선택 -->
         <div class="col-auto">
            <button id="calendar-btn" class="btn btn-out bg-white text-secondary category_btn">
               날짜 선택 <i class="fa-solid fa-calendar-days"></i>
            </button>
            <input type="button" name="datetimes" id="calendar-input" disabled class="btn" />
         </div>

         <!-- 메뉴 선택 -->
         <div class="col-auto">
            <button class="btn text-secondary bg-white category_btn menu_btn">
               메뉴 <i class="fa-solid fa-utensils"></i>
            </button>
            <div class="card food_box">
               <div class="card-body m_card_body row justify-content-center ">
                  <button class="btn border btn-icon col-3">
                     <img src="/img/icon/bibimbap_8740490.png" alt="food_icon" class="icon">
                     <div class="text">한식</div>
                  </button>
                  <!-- 기타 메뉴들 추가 -->
               </div>
            </div>
         </div>

         <!-- 지도 선택 -->
         <div class="col-auto">
            <button class="btn text-secondary bg-white category_btn" onclick="showMap()">
               지도 선택<i class="fa-solid fa-map ml-1"></i>
            </button>
         </div>
      </div>
      <hr>
   </div>

   <!-- 지도 요소 -->
   <div id="map"></div>
   
   <button id="closeMap" onclick="closeMap()">지도 닫기</button>

   <!-- 중간 긴 캐로셀 -->
   <div class="section2 my-5">
      <div class="container my-5">
         <div id="carouselExampleFade" class="carousel slide my-5" data-ride="carousel">
            <ol class="carousel-indicators">
               <li data-target="#carouselExampleCaptions" data-slide-to="0" class="active"></li>
               <li data-target="#carouselExampleCaptions" data-slide-to="1"></li>
            </ol>
            <div class="carousel-inner">
               <div class="carousel-item active">
                  <img src="/img/sub_carousel/carousel_1.png" class="d-block w-100" alt="...">
               </div>
               <div class="carousel-item">
                  <img src="/img/sub_carousel/carousel_2.png" class="d-block w-100" alt="...">
               </div>
            </div>
            <button class="carousel-control-prev" type="button" data-target="#carouselExampleFade"
               data-slide="prev">
               <span class="carousel-control-prev-icon" aria-hidden="true"></span>
               <span class="sr-only">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-target="#carouselExampleFade"
               data-slide="next">
               <span class="carousel-control-next-icon" aria-hidden="true"></span>
               <span class="sr-only">Next</span>
            </button>
         </div>
      </div>
   </div>

   <!-- 순서필터 -->
   <div class="container">
      <div class="row justify-content-between align-items-center">
         <div class="col-auto">
            <!-- 전체 버튼 -->
            <div class="dropdown">
               <button class="btn bg-white dropdown-toggle" type="button" data-toggle="dropdown"
                  aria-expanded="false">전체</button>
               <div class="dropdown-menu">
                  <a class="dropdown-item" href="#">전체</a>
                  <a class="dropdown-item" href="#">새로 올라온 순</a>
                  <a class="dropdown-item" href="#">오래된 순</a>
                  <a class="dropdown-item" href="#">별점 순</a>
                  <a class="dropdown-item" href="#">댓글 많은 순</a>
                  <a class="dropdown-item" href="#">좋아요 순</a>
               </div>
            </div>
         </div>
         <div class="col-auto d-flex align-items-center">
            <!-- 검색란 -->
            <div class="d-flex align-items-center">
               <input type="text" class="form-control custom-search-bar" placeholder="검색어를 입력하세요">
               <button class="btn btn-dark ml-2" style="width: 70px;">검색</button>
            </div>
         </div>
      </div>
      <hr>
   </div>

   <!-- 카드 섹션 -->
   <div class="section3 mt-5">
      <div class="container my-5">
         <h3 class="mt-5">이번주 <span class="text-danger">🔥HOT한</span> 리뷰</h3>
         <div class="row">
            <div class="col-xl-4 col-lg-6 my-2" th:each="review : ${reviewPage}">
               <div class="card S3_card h-100 custom-border mx-auto">
                  <a href="" class="text-dark">
                     <h5 class="d-flex align-items-center mt-3 ml-3">
                        <img src="/img/profile/1.jpg" alt="" class="rounded-circle" style="width: 50px;">
                        <span class="d-flex align-items-center mx-2">맛집헌터</span>
                     </h5>
                  </a>
                  <div th:id="'S3_review_carouselExample' + ${review.id}"
                     class="carousel slide carousel-fade px-2" data-ride="carousel">
                     <div class="carousel-inner S3_carousel-inner">
                        <a th:href="@{/review_detail/{id}(id=${review.id})}">
                           <div class="carousel-item S3_carousel-item"
                              th:each="imageMap, iterStat : ${review.reviewImageMap}"
                              th:classappend="${iterStat.index == 0} ? ' active'">
                              <img th:src="@{${imageMap.reviewImage.filepath}}" alt="Review detail Image"
                                 class="d-block w-100 S3_custom-card-img">
                           </div>
                        </a>
                     </div>
                     <!-- 캐러셀 제어 버튼 -->
                     <div class="d-block d-lg-none">
                        <a class="carousel-control-prev S3_hover_btn"
                           th:href="'#S3_review_carouselExample' + ${review.id}" role="button"
                           data-slide="prev">
                           <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                           <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next S3_hover_btn"
                           th:href="'#S3_review_carouselExample' + ${review.id}" role="button"
                           data-slide="next">
                           <span class="carousel-control-next-icon" aria-hidden="true"></span>
                           <span class="sr-only">Next</span>
                        </a>
                     </div>
                  </div>

                  <div class="card-body d-flex flex-column">
                     <div class="row p-3 S3_text-box ">
                        <div class="col-8 mx-0">
                           <a th:href="@{/review_detail/{id}(id=${review.id})}" class="text-dark">
                              <h5 class="card-title S3_card-title" th:text="${review.title}"></h5>
                           </a>
                        </div>
                        <div class="col-4 text-end text-right likes">
                           <span class="text-dark mx-1"><img src="/img/icon/heart-regular.svg" alt="like"
                                 style="width: 20px" class="img-fluid mr-1" />566</span>
                        </div>

                        <p class="col-12 S3_store mb-2">
                           <small>⭐⭐⭐⭐⭐</small> <a href=""><small class="text-muted"><i
                                    class="fa-solid fa-location-dot mx-2" style="color: #000000;"></i>
                                 <span class="font-weight-bold">수원역 근처</span> 돼지냠냠</small></a>
                        </p>

                        <p class="card-text S3_card-text mt-auto col-12 mb-2" th:text="${review.content}"></p>

                        <div class="mb-3 S3_tag_box ml-1">
                           <span th:each="tagMap : ${review.tagMaps}" class="S3_tag_box">
                              <span class="badge badge-pill border border-dark"
                                 th:text="'#'+${tagMap.reviewTag.name}"> </span>
                           </span>
                           <p class="card-text mt-2">
                              <small class="text-muted"><span
                                    th:text="${#temporals.format(review.createDate, 'yyyy-MM-dd HH:mm')}"></span>
                                 업데이트</small>
                           </p>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <div class="container">
         <h3 class="mt-5 my-3">새로 올라온 후기</h3>
      </div>
   </div>

   <!-- 지도 데이터 표시 -->
   <div th:each="store : ${stores}">
       <input type="hidden" class="store-lat" th:value="${store.storeLatitude}" />
       <input type="hidden" class="store-lng" th:value="${store.storeLongitude}" />
       <input type="hidden" class="store-name" th:value="${store.storeName}" />
   </div>

   <script>
       var map;
       var markers = [];
       var overlays = [];
       var currentOverlay = null;  // 현재 표시 중인 오버레이 저장

       // 서브 지역을 업데이트하는 함수
       function updateSubRegion() {
           var region1 = document.getElementById('region1').value;
           var region2 = document.getElementById('region2');
           region2.innerHTML = '';  // 기존 옵션 초기화

           // 선택된 지역에 따라 하위 지역을 동적으로 추가
           if (region1 === 'seoul') {
               var options = [
                   {name: '강남구', value: '37.517236,127.047325'},
                   {name: '서초구', value: '37.530125,126.975403'}
               ];
           } else if (region1 === 'busan') {
               var options = [
                   {name: '해운대구', value: '35.179554,129.075641'},
                   {name: '수영구', value: '35.127329,128.980051'}
               ];
           } else if (region1 === 'gyeonggi') {
               var options = [
                   {name: '권선구', value: '37.2414248,127.0161908'},
                   {name: '수영구', value: '35.127329,128.980051'}
               ];
           }

           // 새로운 옵션을 추가
           for (var i = 0; i < options.length; i++) {
               var option = document.createElement('option');
               option.value = options[i].value;
               option.text = options[i].name;
               region2.add(option);
           }
       }

       // 지도를 띄우고 마커를 표시하는 함수
       function showMap() {
           var mapDiv = document.getElementById('map');
           var closeButton = document.getElementById('closeMap');
           mapDiv.style.display = 'block';  // 지도를 보여줌
           closeButton.style.display = 'block';  // 닫기 버튼도 표시

           // 지도가 아직 생성되지 않은 경우에만 생성
           if (!map) {
               var container = mapDiv;
               var options = {
                   center: new kakao.maps.LatLng(37.517236, 127.047325),  // 기본 좌표 (서울)
                   level: 5
               };
               map = new kakao.maps.Map(container, options);  // 지도를 생성
           }

           // 기존 마커와 오버레이를 모두 삭제
           markers.forEach(marker => marker.setMap(null));
           overlays.forEach(overlay => overlay.setMap(null));  // 모든 오버레이 닫기
           markers = [];
           overlays = [];
           currentOverlay = null;  // 현재 오버레이 초기화

           // 페이지에 있는 가게 정보 가져오기
           var latElements = document.querySelectorAll('.store-lat');
           var lngElements = document.querySelectorAll('.store-lng');
           var nameElements = document.querySelectorAll('.store-name');  // 가게 이름 가져옴

           // 마커 생성 및 클릭 이벤트 추가
           for (let i = 0; i < latElements.length; i++) {
               var lat = parseFloat(latElements[i].value);
               var lng = parseFloat(lngElements[i].value);
               var storeName = nameElements[i].value;  // 가게 이름

               // 위도와 경도 값이 유효한 경우에만 마커 생성
               if (!isNaN(lat) && !isNaN(lng)) {
                   var markerPosition = new kakao.maps.LatLng(lat, lng);
                   var marker = new kakao.maps.Marker({
                       position: markerPosition
                   });

                   marker.setMap(map);
                   markers.push(marker);

                   // 오버레이 내용 생성 (카드 형식)
                   var content = `
                       <div class="card" style="width: 15rem;">
                         <img src="https://via.placeholder.com/150" class="card-img-top" alt="가게 이미지">
                         <div class="card-body">
                           <h5 class="card-title">` + storeName + `</h5>
                         </div>
                       </div>
                   `;

                   // 오버레이 생성
                   var overlay = new kakao.maps.CustomOverlay({
                       content: content,
                       position: markerPosition,
                       yAnchor: 1.12  // 오버레이가 마커 위에 나타나도록 위치 조정
                   });

                   // 오버레이를 토글 방식으로 표시
                   kakao.maps.event.addListener(marker, 'click', function() {
                       if (currentOverlay === overlay) {
                           currentOverlay.setMap(null);  // 클릭 시 현재 오버레이 닫기
                           currentOverlay = null;  // 오버레이 초기화
                       } else {
                           if (currentOverlay) {
                               currentOverlay.setMap(null);  // 기존 오버레이 닫기
                           }
                           overlay.setMap(map);  // 새로운 오버레이 표시
                           currentOverlay = overlay;  // 현재 오버레이로 설정
                       }
                   });

                   overlays.push(overlay);  // 오버레이를 배열에 추가하여 추적
               }
           }

           // 마지막 마커로 지도의 중심을 이동
           if (markers.length > 0) {
               var lastMarkerPosition = markers[markers.length - 1].getPosition();
               map.setCenter(lastMarkerPosition);
           }
       }

       // 지도를 닫는 함수
       function closeMap() {
           var mapDiv = document.getElementById('map');
           var closeButton = document.getElementById('closeMap');
           mapDiv.style.display = 'none';  // 지도를 숨김
           closeButton.style.display = 'none';  // 닫기 버튼 숨김

           // 지도 닫을 때 오버레이도 모두 제거
           overlays.forEach(overlay => overlay.setMap(null));
           currentOverlay = null;  // 현재 오버레이 초기화
           overlays = [];  // 오버레이 배열 초기화
       }
   </script>




</div>

</html>