<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">

<head>
   <!-- moment.js í¬í•¨ (í•„ìˆ˜) -->
   <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
   <!-- daterangepicker CSS í¬í•¨ -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
   <!-- daterangepicker JS í¬í•¨ -->
   <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
   <!-- ì»¤ìŠ¤í…€ CSS ì¶”ê°€ -->
   <link rel="stylesheet" href="/css/review_page.css">
   <link rel="stylesheet" href="/css/category.css">
   <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ í¬í•¨ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´í›„ì— ë¡œë“œ) -->
   <script src="js/review_page_category.js"></script>
   <meta name="_csrf" th:content="${_csrf.token}" />
   <meta name="_csrf_header" th:content="${_csrf.headerName}" />

   <!-- ì§€ë„ API í¬í•¨ -->
   <script type="text/javascript"
      src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4711bf21a08674cf6e20b64443d34887"></script>

   <style>
      #map {
         display: none;
         /* ì´ˆê¸°ì—ëŠ” ì§€ë„ê°€ ë³´ì´ì§€ ì•Šë„ë¡ ì„¤ì • */
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         z-index: 1000;
      }
     
     #test{
      width: 200px;
      height: 200px;
      position: absolute;
      z-index: 999999999;
     }

      #closeMap {
         display: none;
         /* ì´ˆê¸°ì—ëŠ” ë²„íŠ¼ì´ ë³´ì´ì§€ ì•Šë„ë¡ ì„¤ì • */
         position: fixed;
         top: 10px;
         right: 10px;
         z-index: 1001;
         background-color: #fff;
         border: none;
         padding: 10px 20px;
         font-size: 16px;
         cursor: pointer;
      }
	  .card-body {
	      padding: 5px; /* íŒ¨ë”©ì„ ì¤„ì—¬ì„œ ë°•ìŠ¤ í¬ê¸°ë¥¼ ì¤„ì„ */
	      height: auto; /* ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì • */
	  }

	  .card {
	      height: auto; /* ì¹´ë“œ ì „ì²´ ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì • */
	      display: flex;
	      flex-direction: column;
	      justify-content: space-between; /* ë‚´ìš©ë“¤ì´ ê· ë“±í•˜ê²Œ ë¶„í¬ë˜ë„ë¡ ì¡°ì • */
	  }

	  .card-title {
	      font-size: 20px; /* í…ìŠ¤íŠ¸ í¬ê¸°ë¥¼ ì ì ˆí•˜ê²Œ ì¡°ì • */
		  margin-top: 20px;
	      margin-bottom: 35px; /* ì´ë¦„ ì•„ë˜ì— ì¶”ê°€ì ì¸ ì—¬ë°±ì„ ìµœì†Œí™” */
	  }

   </style>
</head>
<div layout:fragment="content">
   <!-- ê²€ìƒ‰ë€ -->
   <div class="section1 container mt-5">
      <div class="row d-flex justify-content-end">
         <!--ì§€ì—­ì„ íƒ-->
         <div class="col-auto">
            <select name="h_area1" id="region1" onChange="updateSubRegion()" class="h_area1 form-control">
               <option>-ì§€ì—­ì„ íƒ-</option>
               <option value="seoul">ì„œìš¸</option>
               <option value="busan">ë¶€ì‚°</option>
               <option value="gyeonggi">ê²½ê¸°ë„</option>
               <option value="daegu">ëŒ€êµ¬</option>
               <!-- ê¸°íƒ€ ì§€ì—­ë“¤ ì¶”ê°€ -->
            </select>
         </div>

         <!--ë™ë„¤ ì„ íƒ-->
         <div class="col-auto">
            <select name="h_area2" id="region2" class="form-control">
               <option>-ì„ íƒ-</option>
            </select>
         </div>

         <!--ì¸ì›ìˆ˜ ì„ íƒ-->
         <div class="col-auto">
            <!--People Count Button-->
            <button class="btn text-secondary bg-white P_C_button category_btn" id="toggleButton">
               ì¸ì›ìˆ˜<i class="fa-solid fa-user ml-1"></i>
            </button>
            <!--ì¸ì›ìˆ˜ ë°•ìŠ¤-->
            <div class="card ml-5 mt-5 hide_box" id="rangeBox" style="width: 300px;">
               <div class="card-body text-center">
                  <span>ì¸ì›</span> <label id="rangeValue" for="customRange2">1</label><span>ëª…</span>
                  <input type="range" class="custom-range" min="1" max="10" value="1" id="customRange2">
               </div>
               <button class="btn btn-dark ca_button w-100">ì¸ì›ìˆ˜ ì ìš©</button>
            </div>
         </div>

         <!-- ë‚ ì§œ ì„ íƒ -->
         <div class="col-auto">
            <button id="calendar-btn" class="btn btn-out bg-white text-secondary category_btn">
               ë‚ ì§œ ì„ íƒ <i class="fa-solid fa-calendar-days"></i>
            </button>
            <input type="button" name="datetimes" id="calendar-input" disabled class="btn" />
         </div>

         <!-- ë©”ë‰´ ì„ íƒ -->
         <div class="col-auto">
            <button class="btn text-secondary bg-white category_btn menu_btn">
               ë©”ë‰´ <i class="fa-solid fa-utensils"></i>
            </button>
            <div class="card food_box">
               <div class="card-body m_card_body row justify-content-center ">
                  <button class="btn border btn-icon col-3">
                     <img src="/img/icon/bibimbap_8740490.png" alt="food_icon" class="icon">
                     <div class="text">í•œì‹</div>
                  </button>
                  <!-- ê¸°íƒ€ ë©”ë‰´ë“¤ ì¶”ê°€ -->
               </div>
            </div>
         </div>

         <!-- ì§€ë„ ì„ íƒ -->
         <div class="col-auto">
            <button class="btn text-secondary bg-white category_btn" onclick="showMap()">
               ì§€ë„ ì„ íƒ<i class="fa-solid fa-map ml-1"></i>
            </button>
         </div>
      </div>
      <hr>
   </div>

   <!-- ì§€ë„ ìš”ì†Œ -->
   <div id="map"></div>
   
   <button id="closeMap" onclick="closeMap()">ì§€ë„ ë‹«ê¸°</button>

   <!-- ì¤‘ê°„ ê¸´ ìºë¡œì…€ -->
   <div class="section2 my-5">
      <div class="container my-5">
         <div id="carouselExampleFade" class="carousel slide my-5" data-ride="carousel">
            <ol class="carousel-indicators">
               <li data-target="#carouselExampleCaptions" data-slide-to="0" class="active"></li>
               <li data-target="#carouselExampleCaptions" data-slide-to="1"></li>
            </ol>
            <div class="carousel-inner">
               <div class="carousel-item active">
                  <img src="/img/sub_carousel/carousel_1.png" class="d-block w-100" alt="...">
               </div>
               <div class="carousel-item">
                  <img src="/img/sub_carousel/carousel_2.png" class="d-block w-100" alt="...">
               </div>
            </div>
            <button class="carousel-control-prev" type="button" data-target="#carouselExampleFade"
               data-slide="prev">
               <span class="carousel-control-prev-icon" aria-hidden="true"></span>
               <span class="sr-only">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-target="#carouselExampleFade"
               data-slide="next">
               <span class="carousel-control-next-icon" aria-hidden="true"></span>
               <span class="sr-only">Next</span>
            </button>
         </div>
      </div>
   </div>

   <!-- ìˆœì„œí•„í„° -->
   <div class="container">
      <div class="row justify-content-between align-items-center">
         <div class="col-auto">
            <!-- ì „ì²´ ë²„íŠ¼ -->
            <div class="dropdown">
               <button class="btn bg-white dropdown-toggle" type="button" data-toggle="dropdown"
                  aria-expanded="false">ì „ì²´</button>
               <div class="dropdown-menu">
                  <a class="dropdown-item" href="#">ì „ì²´</a>
                  <a class="dropdown-item" href="#">ìƒˆë¡œ ì˜¬ë¼ì˜¨ ìˆœ</a>
                  <a class="dropdown-item" href="#">ì˜¤ë˜ëœ ìˆœ</a>
                  <a class="dropdown-item" href="#">ë³„ì  ìˆœ</a>
                  <a class="dropdown-item" href="#">ëŒ“ê¸€ ë§ì€ ìˆœ</a>
                  <a class="dropdown-item" href="#">ì¢‹ì•„ìš” ìˆœ</a>
               </div>
            </div>
         </div>
         <div class="col-auto d-flex align-items-center">
            <!-- ê²€ìƒ‰ë€ -->
            <div class="d-flex align-items-center">
               <input type="text" class="form-control custom-search-bar" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
               <button class="btn btn-dark ml-2" style="width: 70px;">ê²€ìƒ‰</button>
            </div>
         </div>
      </div>
      <hr>
   </div>

   <!-- ì¹´ë“œ ì„¹ì…˜ -->
   <div class="section3 mt-5">
      <div class="container my-5">
         <h3 class="mt-5">ì´ë²ˆì£¼ <span class="text-danger">ğŸ”¥HOTí•œ</span> ë¦¬ë·°</h3>
         <div class="row">
            <div class="col-xl-4 col-lg-6 my-2" th:each="review : ${reviewPage}">
               <div class="card S3_card h-100 custom-border mx-auto">
                  <a href="" class="text-dark">
                     <h5 class="d-flex align-items-center mt-3 ml-3">
                        <img src="/img/profile/1.jpg" alt="" class="rounded-circle" style="width: 50px;">
                        <span class="d-flex align-items-center mx-2">ë§›ì§‘í—Œí„°</span>
                     </h5>
                  </a>
                  <div th:id="'S3_review_carouselExample' + ${review.id}"
                     class="carousel slide carousel-fade px-2" data-ride="carousel">
                     <div class="carousel-inner S3_carousel-inner">
                        <a th:href="@{/review_detail/{id}(id=${review.id})}">
                           <div class="carousel-item S3_carousel-item"
                              th:each="imageMap, iterStat : ${review.reviewImageMap}"
                              th:classappend="${iterStat.index == 0} ? ' active'">
                              <img th:src="@{${imageMap.reviewImage.filepath}}" alt="Review detail Image"
                                 class="d-block w-100 S3_custom-card-img">
                           </div>
                        </a>
                     </div>
                     <!-- ìºëŸ¬ì…€ ì œì–´ ë²„íŠ¼ -->
                     <div class="d-block d-lg-none">
                        <a class="carousel-control-prev S3_hover_btn"
                           th:href="'#S3_review_carouselExample' + ${review.id}" role="button"
                           data-slide="prev">
                           <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                           <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next S3_hover_btn"
                           th:href="'#S3_review_carouselExample' + ${review.id}" role="button"
                           data-slide="next">
                           <span class="carousel-control-next-icon" aria-hidden="true"></span>
                           <span class="sr-only">Next</span>
                        </a>
                     </div>
                  </div>

                  <div class="card-body d-flex flex-column">
                     <div class="row p-3 S3_text-box ">
                        <div class="col-8 mx-0">
                           <a th:href="@{/review_detail/{id}(id=${review.id})}" class="text-dark">
                              <h5 class="card-title S3_card-title" th:text="${review.title}"></h5>
                           </a>
                        </div>
                        <div class="col-4 text-end text-right likes">
                           <span class="text-dark mx-1"><img src="/img/icon/heart-regular.svg" alt="like"
                                 style="width: 20px" class="img-fluid mr-1" />566</span>
                        </div>

                        <p class="col-12 S3_store mb-2">
                           <small>â­â­â­â­â­</small> <a href=""><small class="text-muted"><i
                                    class="fa-solid fa-location-dot mx-2" style="color: #000000;"></i>
                                 <span class="font-weight-bold">ìˆ˜ì›ì—­ ê·¼ì²˜</span> ë¼ì§€ëƒ ëƒ </small></a>
                        </p>

                        <p class="card-text S3_card-text mt-auto col-12 mb-2" th:text="${review.content}"></p>

                        <div class="mb-3 S3_tag_box ml-1">
                           <span th:each="tagMap : ${review.tagMaps}" class="S3_tag_box">
                              <span class="badge badge-pill border border-dark"
                                 th:text="'#'+${tagMap.reviewTag.name}"> </span>
                           </span>
                           <p class="card-text mt-2">
                              <small class="text-muted"><span
                                    th:text="${#temporals.format(review.createDate, 'yyyy-MM-dd HH:mm')}"></span>
                                 ì—…ë°ì´íŠ¸</small>
                           </p>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <div class="container">
         <h3 class="mt-5 my-3">ìƒˆë¡œ ì˜¬ë¼ì˜¨ í›„ê¸°</h3>
      </div>
   </div>

   <!-- ì§€ë„ ë°ì´í„° í‘œì‹œ -->
   <div th:each="store : ${stores}">
       <input type="hidden" class="store-lat" th:value="${store.storeLatitude}" />
       <input type="hidden" class="store-lng" th:value="${store.storeLongitude}" />
       <input type="hidden" class="store-name" th:value="${store.storeName}" />
   </div>

   <script>
       var map;
       var markers = [];
       var overlays = [];
       var currentOverlay = null;  // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì˜¤ë²„ë ˆì´ ì €ì¥

       // ì„œë¸Œ ì§€ì—­ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
       function updateSubRegion() {
           var region1 = document.getElementById('region1').value;
           var region2 = document.getElementById('region2');
           region2.innerHTML = '';  // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”

           // ì„ íƒëœ ì§€ì—­ì— ë”°ë¼ í•˜ìœ„ ì§€ì—­ì„ ë™ì ìœ¼ë¡œ ì¶”ê°€
           if (region1 === 'seoul') {
               var options = [
                   {name: 'ê°•ë‚¨êµ¬', value: '37.517236,127.047325'},
                   {name: 'ì„œì´ˆêµ¬', value: '37.530125,126.975403'}
               ];
           } else if (region1 === 'busan') {
               var options = [
                   {name: 'í•´ìš´ëŒ€êµ¬', value: '35.179554,129.075641'},
                   {name: 'ìˆ˜ì˜êµ¬', value: '35.127329,128.980051'}
               ];
           } else if (region1 === 'gyeonggi') {
               var options = [
                   {name: 'ê¶Œì„ êµ¬', value: '37.2414248,127.0161908'},
                   {name: 'ìˆ˜ì˜êµ¬', value: '35.127329,128.980051'}
               ];
           }

           // ìƒˆë¡œìš´ ì˜µì…˜ì„ ì¶”ê°€
           for (var i = 0; i < options.length; i++) {
               var option = document.createElement('option');
               option.value = options[i].value;
               option.text = options[i].name;
               region2.add(option);
           }
       }

       // ì§€ë„ë¥¼ ë„ìš°ê³  ë§ˆì»¤ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
       function showMap() {
           var mapDiv = document.getElementById('map');
           var closeButton = document.getElementById('closeMap');
           mapDiv.style.display = 'block';  // ì§€ë„ë¥¼ ë³´ì—¬ì¤Œ
           closeButton.style.display = 'block';  // ë‹«ê¸° ë²„íŠ¼ë„ í‘œì‹œ

           // ì§€ë„ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ìƒì„±
           if (!map) {
               var container = mapDiv;
               var options = {
                   center: new kakao.maps.LatLng(37.517236, 127.047325),  // ê¸°ë³¸ ì¢Œí‘œ (ì„œìš¸)
                   level: 5
               };
               map = new kakao.maps.Map(container, options);  // ì§€ë„ë¥¼ ìƒì„±
           }

           // ê¸°ì¡´ ë§ˆì»¤ì™€ ì˜¤ë²„ë ˆì´ë¥¼ ëª¨ë‘ ì‚­ì œ
           markers.forEach(marker => marker.setMap(null));
           overlays.forEach(overlay => overlay.setMap(null));  // ëª¨ë“  ì˜¤ë²„ë ˆì´ ë‹«ê¸°
           markers = [];
           overlays = [];
           currentOverlay = null;  // í˜„ì¬ ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™”

           // í˜ì´ì§€ì— ìˆëŠ” ê°€ê²Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
           var latElements = document.querySelectorAll('.store-lat');
           var lngElements = document.querySelectorAll('.store-lng');
           var nameElements = document.querySelectorAll('.store-name');  // ê°€ê²Œ ì´ë¦„ ê°€ì ¸ì˜´

           // ë§ˆì»¤ ìƒì„± ë° í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
           for (let i = 0; i < latElements.length; i++) {
               var lat = parseFloat(latElements[i].value);
               var lng = parseFloat(lngElements[i].value);
               var storeName = nameElements[i].value;  // ê°€ê²Œ ì´ë¦„

               // ìœ„ë„ì™€ ê²½ë„ ê°’ì´ ìœ íš¨í•œ ê²½ìš°ì—ë§Œ ë§ˆì»¤ ìƒì„±
               if (!isNaN(lat) && !isNaN(lng)) {
                   var markerPosition = new kakao.maps.LatLng(lat, lng);
                   var marker = new kakao.maps.Marker({
                       position: markerPosition
                   });

                   marker.setMap(map);
                   markers.push(marker);

                   // ì˜¤ë²„ë ˆì´ ë‚´ìš© ìƒì„± (ì¹´ë“œ í˜•ì‹)
                   var content = `
                       <div class="card" style="width: 15rem;">
                         <img src="https://via.placeholder.com/150" class="card-img-top" alt="ê°€ê²Œ ì´ë¯¸ì§€">
                         <div class="card-body">
                           <h5 class="card-title">` + storeName + `</h5>
                         </div>
                       </div>
                   `;

                   // ì˜¤ë²„ë ˆì´ ìƒì„±
                   var overlay = new kakao.maps.CustomOverlay({
                       content: content,
                       position: markerPosition,
                       yAnchor: 1.12  // ì˜¤ë²„ë ˆì´ê°€ ë§ˆì»¤ ìœ„ì— ë‚˜íƒ€ë‚˜ë„ë¡ ìœ„ì¹˜ ì¡°ì •
                   });

                   // ì˜¤ë²„ë ˆì´ë¥¼ í† ê¸€ ë°©ì‹ìœ¼ë¡œ í‘œì‹œ
                   kakao.maps.event.addListener(marker, 'click', function() {
                       if (currentOverlay === overlay) {
                           currentOverlay.setMap(null);  // í´ë¦­ ì‹œ í˜„ì¬ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
                           currentOverlay = null;  // ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™”
                       } else {
                           if (currentOverlay) {
                               currentOverlay.setMap(null);  // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
                           }
                           overlay.setMap(map);  // ìƒˆë¡œìš´ ì˜¤ë²„ë ˆì´ í‘œì‹œ
                           currentOverlay = overlay;  // í˜„ì¬ ì˜¤ë²„ë ˆì´ë¡œ ì„¤ì •
                       }
                   });

                   overlays.push(overlay);  // ì˜¤ë²„ë ˆì´ë¥¼ ë°°ì—´ì— ì¶”ê°€í•˜ì—¬ ì¶”ì 
               }
           }

           // ë§ˆì§€ë§‰ ë§ˆì»¤ë¡œ ì§€ë„ì˜ ì¤‘ì‹¬ì„ ì´ë™
           if (markers.length > 0) {
               var lastMarkerPosition = markers[markers.length - 1].getPosition();
               map.setCenter(lastMarkerPosition);
           }
       }

       // ì§€ë„ë¥¼ ë‹«ëŠ” í•¨ìˆ˜
       function closeMap() {
           var mapDiv = document.getElementById('map');
           var closeButton = document.getElementById('closeMap');
           mapDiv.style.display = 'none';  // ì§€ë„ë¥¼ ìˆ¨ê¹€
           closeButton.style.display = 'none';  // ë‹«ê¸° ë²„íŠ¼ ìˆ¨ê¹€

           // ì§€ë„ ë‹«ì„ ë•Œ ì˜¤ë²„ë ˆì´ë„ ëª¨ë‘ ì œê±°
           overlays.forEach(overlay => overlay.setMap(null));
           currentOverlay = null;  // í˜„ì¬ ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™”
           overlays = [];  // ì˜¤ë²„ë ˆì´ ë°°ì—´ ì´ˆê¸°í™”
       }
   </script>




</div>

</html>